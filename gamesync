#!/usr/bin/env bash

# shellcheck disable=SC2145
# shellcheck disable=SC2068

set -e -o pipefail

# Load environment variables from the file
while IFS='=' read -r key value; do
    export "$key"="$value"
done < ~/.local/share/gamesync/gamesync.env

# gamesync can be executed outside of steam, if so, assign SteamAppId to 0
if [[ -z ${SteamAppId} ]]; then
  SteamAppId="0"
fi

IFS=' ' read -ra commands <<< $@
executableName="${commands[-1]}"

# source any dependencies
source /usr/local/share/gamesync/gamesync-utilities

log "Syncing saves before executing $@"

log "Loading variables in ~/.gamesync"

# shellcheck disable=SC2154
log "Steam app id: ${SteamAppId}"
log "Executable name: ${executableName}"

log "Checking if syncthing is running..."

check_syncthing "${SYNCTHING_API}" "${SYNCTHING_URL}" "${SYNCTHING_FOLDER_ID}"
syncthing_status=$?

if [[ ! ${syncthing_status} = 0  ]]; then
  log "Syncthing is not working, check the logs!"
  log "Syncthing status code: ${syncthing_status}"
  log "Continuing with synchronizing from ~/.local/share/gamesync/saves anyway"
else
  log "Syncthing is up"
fi

set +e +o pipefail

log "executing game!"

eval 'env LD_PRELOAD="${LD_PRELOAD}" $@'

log "done!"

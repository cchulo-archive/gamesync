#!/usr/bin/env bash

# shellcheck disable=SC2145
# shellcheck disable=SC2068
# shellcheck disable=SC1090

if [[ -f /usr/local/lib/gamesync/gamesync-logging ]]; then
  GAMESYNC_LOGGING="/usr/local/lib/gamesync/gamesync-logging"
  GAMESYNC_UTILITIES="/usr/local/lib/gamesync/gamesync-utilities"
  GAMESYNC_PY="/usr/local/lib/gamesync/gamesync.py"
else
  GAMESYNC_LOGGING="${HOME}/.local/lib/gamesync/gamesync-logging"
  GAMESYNC_UTILITIES="${HOME}/.local/lib/gamesync/gamesync-utilities"
  GAMESYNC_PY="${HOME}/.local/lib/gamesync/gamesync.py"
fi

# source any dependencies
source "${GAMESYNC_LOGGING}"
source "${GAMESYNC_UTILITIES}"

set -e -o pipefail

# Load environment variables from ~/.local/share/gamesync/gamesync.env
while IFS='=' read -r key value; do
  if [[ -n ${key} ]]; then
    export "$key"="$value"
  fi
done < ~/.local/share/gamesync/gamesync.env

# gamesync can be executed outside of steam, if so, assign SteamAppId to 0
if [[ -z ${SteamAppId} ]]; then
  log_debug "Assigning SteamAppId to 0, this can happen is gamesync is used outside of steam"
  SteamAppId="0"
fi

# extract executable name
IFS=' ' read -ra commands <<< $@
executableName="${commands[-1]}"

log_info "Syncing saves before executing $@"

# shellcheck disable=SC2154
log_info "Steam app id: ${SteamAppId}"
log_info "Executable name: ${executableName}"

log_info "Checking if syncthing is running..."

log_debug "Before LD_LIBRARY_PATH: ${LD_LIBRARY_PATH}"

LD_LIBRARY_PATH="" check_syncthing "${SYNCTHING_API}" "${SYNCTHING_URL}" "${SYNCTHING_FOLDER_ID}"
syncthing_status=$?

log_debug "After LD_LIBRARY_PATH: ${LD_LIBRARY_PATH}"

if [[ "${syncthing_status}" = "${SYNCTHING_ERR_NO_CONNECTION}" ]]; then
  log_error "Timed out waiting for for syncthing to synchronize, try again later"
  exit "${SYNCTHING_ERR_NO_CONNECTION}"
elif [[ "${syncthing_status}" = "${SYNCTHING_ERR_FETCH_STATUS}" ]]; then
  log_error "Could not retrieve status from syncthing"
  exit "${SYNCTHING_ERR_FETCH_STATUS}"
elif [[ ! "${syncthing_status}" = "0"  ]]; then
  log_warning "Syncthing is not working, check the logs!"
  log_warning "Syncthing status code: ${syncthing_status}"
  log_warning "Continuing with synchronizing from ~/.local/share/gamesync/saves anyway"
else
  log_info "Syncthing is up"
fi

log_info "Downloading game saves from the staging area..."

${GAMESYNC_PY} \
  --steamAppId "${SteamAppId}" \
  --executableName "${executableName}" \
  --download

set +e +o pipefail

log_info "executing game!"

eval "env LD_PRELOAD=\"${LD_PRELOAD}\" $@"

log_info "done! Staging updated saves for upload..."

${GAMESYNC_PY} \
  --steamAppId "${SteamAppId}" \
  --executableName "${executableName}" \
  --upload
